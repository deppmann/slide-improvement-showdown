<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Slide Improvement Showdown - BIOL 3000</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root {
  --bg: #0f1117;
  --surface: #1a1d27;
  --surface2: #242836;
  --border: #2e3347;
  --text: #e4e6f0;
  --text-dim: #8b8fa3;
  --accent: #6c5ce7;
  --accent2: #00cec9;
  --green: #00b894;
  --red: #e17055;
  --orange: #fdcb6e;
  --pink: #fd79a8;
  --blue: #74b9ff;
  --cat-factual: #e17055;
  --cat-visual: #6c5ce7;
  --cat-clinical: #00cec9;
  --cat-analogy: #fdcb6e;
  --cat-publisher: #fd79a8;
  --cat-other: #74b9ff;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ─── Header ─── */
.header {
  background: linear-gradient(135deg, #1a1d27 0%, #242836 100%);
  border-bottom: 1px solid var(--border);
  padding: 1.5rem 2rem;
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-inner {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  flex-wrap: wrap;
}

.header h1 {
  font-size: 1.5rem;
  font-weight: 800;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: -0.5px;
}

.header .subtitle {
  color: var(--text-dim);
  font-size: 0.85rem;
  margin-top: 0.2rem;
}

.nav-tabs {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.nav-tab {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text-dim);
  padding: 0.5rem 1rem;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 500;
  transition: all 0.2s;
}

.nav-tab:hover { border-color: var(--accent); color: var(--text); }
.nav-tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }

.stats-bar {
  display: flex;
  gap: 1.5rem;
  align-items: center;
}

.stat { text-align: center; }
.stat-num {
  font-size: 1.4rem;
  font-weight: 800;
  color: var(--accent2);
}
.stat-label {
  font-size: 0.7rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* ─── Main Content ─── */
.main {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
}

/* ─── Dashboard View ─── */
.dashboard-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1.5rem;
}

.card-title {
  font-size: 1rem;
  font-weight: 700;
  margin-bottom: 1rem;
  color: var(--text);
}

.chapter-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0.75rem;
}

.chapter-card {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 1rem;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.chapter-card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(108,92,231,0.2);
}

.chapter-card .ch-num {
  font-size: 2rem;
  font-weight: 800;
  color: var(--accent);
}

.chapter-card .ch-name {
  font-size: 0.75rem;
  color: var(--text-dim);
  margin-top: 0.25rem;
  line-height: 1.3;
}

.chapter-card .ch-stats {
  margin-top: 0.5rem;
  font-size: 0.75rem;
  color: var(--accent2);
  font-weight: 600;
}

/* ─── Heatmap ─── */
.heatmap-container {
  grid-column: 1 / -1;
}

.heatmap-chapter-title {
  font-size: 0.9rem;
  font-weight: 600;
  margin: 1rem 0 0.5rem;
  color: var(--text-dim);
}

.heatmap-row {
  display: flex;
  flex-wrap: wrap;
  gap: 3px;
}

.heatmap-cell {
  width: 28px;
  height: 28px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.55rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
  position: relative;
}

.heatmap-cell:hover {
  transform: scale(1.4);
  z-index: 10;
  box-shadow: 0 2px 10px rgba(0,0,0,0.5);
}

.heatmap-cell.heat-0 { background: var(--surface2); color: var(--text-dim); }
.heatmap-cell.heat-1 { background: #2d3a2d; color: #69db7c; }
.heatmap-cell.heat-2 { background: #2d4a2d; color: #69db7c; }
.heatmap-cell.heat-3 { background: #3a5a2d; color: #a9e34b; }
.heatmap-cell.heat-4 { background: #5a5a2d; color: #ffd43b; }
.heatmap-cell.heat-5 { background: #6a3a2d; color: #ff922b; }
.heatmap-cell.heat-6 { background: #7a2a2d; color: #ff6b6b; }

/* ─── Category Legend ─── */
.legend {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  margin: 1rem 0;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  font-size: 0.75rem;
  color: var(--text-dim);
  cursor: pointer;
  padding: 0.3rem 0.6rem;
  border-radius: 6px;
  transition: all 0.2s;
}

.legend-item:hover, .legend-item.active { background: var(--surface2); color: var(--text); }

.legend-dot {
  width: 10px;
  height: 10px;
  border-radius: 3px;
}

/* ─── A/B Comparison View ─── */
.comparison-view { display: none; }

.comparison-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
  gap: 1rem;
}

.comparison-nav {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.btn {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 0.5rem 1rem;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 500;
  transition: all 0.2s;
  font-family: inherit;
}

.btn:hover { border-color: var(--accent); }
.btn-accent { background: var(--accent); border-color: var(--accent); }
.btn-accent:hover { background: #5b4bd6; }
.btn-green { background: var(--green); border-color: var(--green); color: #fff; }
.btn-red { background: var(--red); border-color: var(--red); color: #fff; }

.btn-lg {
  padding: 0.75rem 1.5rem;
  font-size: 1.1rem;
  font-weight: 700;
}

.comparison-panels {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 0;
  align-items: stretch;
}

.panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.panel-header {
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--border);
  font-weight: 700;
  font-size: 0.9rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.panel-header.original { background: linear-gradient(135deg, rgba(231,76,60,0.1), transparent); }
.panel-header.improved { background: linear-gradient(135deg, rgba(0,206,201,0.1), transparent); }

.panel-body {
  padding: 1rem;
  flex: 1;
  display: flex;
  flex-direction: column;
}

.slide-preview {
  width: 100%;
  aspect-ratio: 4/3;
  background: #000;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  position: relative;
}

.slide-preview canvas {
  max-width: 100%;
  max-height: 100%;
}

.slide-preview img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}

.slide-preview iframe {
  width: 100%;
  height: 100%;
  border: none;
}

.slide-preview .loading {
  color: var(--text-dim);
  font-size: 0.85rem;
}

.vs-divider {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 1rem;
}

.vs-badge {
  background: var(--accent);
  color: #fff;
  font-weight: 800;
  font-size: 1.2rem;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 20px rgba(108,92,231,0.4);
}

.submission-info {
  margin-top: 1rem;
  padding: 1rem;
  background: var(--surface2);
  border-radius: 8px;
  font-size: 0.8rem;
  line-height: 1.6;
}

.submission-info .label {
  color: var(--text-dim);
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.65rem;
  letter-spacing: 0.5px;
  margin-bottom: 0.25rem;
}

.submission-info p { margin-bottom: 0.75rem; }

.category-tags {
  display: flex;
  gap: 0.4rem;
  flex-wrap: wrap;
  margin-top: 0.5rem;
}

.cat-tag {
  padding: 0.2rem 0.6rem;
  border-radius: 20px;
  font-size: 0.7rem;
  font-weight: 600;
}

.cat-tag.factual-fix { background: rgba(225,112,85,0.2); color: var(--cat-factual); }
.cat-tag.visual-overhaul { background: rgba(108,92,231,0.2); color: var(--cat-visual); }
.cat-tag.clinical-hook { background: rgba(0,206,201,0.2); color: var(--cat-clinical); }
.cat-tag.aha-analogy { background: rgba(253,203,110,0.2); color: var(--cat-analogy); }
.cat-tag.publisher-comparison { background: rgba(253,121,168,0.2); color: var(--cat-publisher); }
.cat-tag.other { background: rgba(116,185,255,0.2); color: var(--cat-other); }

/* ─── Voting ─── */
.vote-section {
  display: flex;
  justify-content: center;
  gap: 2rem;
  margin: 2rem 0;
  align-items: center;
}

.vote-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  padding: 1rem 2rem;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid var(--border);
  background: var(--surface);
  color: var(--text);
  font-family: inherit;
  min-width: 120px;
}

.vote-btn:hover { transform: translateY(-3px); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
.vote-btn.original-wins:hover { border-color: var(--red); }
.vote-btn.improved-wins:hover { border-color: var(--green); }
.vote-btn.voted { opacity: 0.6; pointer-events: none; }
.vote-btn .vote-icon { font-size: 2rem; }
.vote-btn .vote-label { font-size: 0.8rem; font-weight: 600; }

.vote-count {
  font-size: 0.75rem;
  color: var(--text-dim);
  text-align: center;
  margin-top: 0.5rem;
}

.vote-bar-container {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.vote-bar {
  flex: 1;
  height: 8px;
  border-radius: 4px;
  background: var(--surface2);
  overflow: hidden;
  display: flex;
}

.vote-bar-original {
  background: var(--red);
  transition: width 0.5s;
}

.vote-bar-improved {
  background: var(--green);
  transition: width 0.5s;
}

/* ─── Study Mode ─── */
.study-view { display: none; }

.study-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  max-width: 900px;
  margin: 0 auto;
  overflow: hidden;
}

.study-progress {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--border);
}

.progress-bar {
  flex: 1;
  height: 6px;
  background: var(--surface2);
  border-radius: 3px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  border-radius: 3px;
  transition: width 0.3s;
}

.progress-text {
  font-size: 0.8rem;
  color: var(--text-dim);
  font-weight: 600;
}

.study-body {
  padding: 2rem;
}

.study-prompt {
  text-align: center;
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 1.5rem;
  color: var(--accent2);
}

.study-slide-container {
  display: flex;
  justify-content: center;
  margin-bottom: 1.5rem;
}

.study-slide-preview {
  width: 100%;
  max-width: 700px;
  aspect-ratio: 4/3;
  background: #000;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.study-slide-preview canvas, .study-slide-preview img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}

.study-options {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.75rem;
  margin-top: 1.5rem;
}

.study-option {
  padding: 1rem;
  background: var(--surface2);
  border: 2px solid var(--border);
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 0.85rem;
  text-align: center;
  font-family: inherit;
  color: var(--text);
}

.study-option:hover { border-color: var(--accent); transform: translateY(-1px); }
.study-option.correct { border-color: var(--green); background: rgba(0,184,148,0.15); }
.study-option.wrong { border-color: var(--red); background: rgba(225,112,85,0.15); }

.reveal-section {
  display: none;
  margin-top: 1.5rem;
  padding: 1.5rem;
  background: var(--surface2);
  border-radius: 10px;
  border-left: 3px solid var(--accent2);
}

.reveal-section h3 {
  font-size: 0.9rem;
  margin-bottom: 0.75rem;
  color: var(--accent2);
}

.reveal-section p {
  font-size: 0.8rem;
  line-height: 1.6;
  color: var(--text-dim);
}

.study-score {
  text-align: center;
  padding: 3rem;
}

.study-score .score-num {
  font-size: 4rem;
  font-weight: 800;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* ─── Leaderboard ─── */
.leaderboard-view { display: none; }

.leaderboard-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 4px;
}

.leaderboard-table th {
  text-align: left;
  padding: 0.75rem 1rem;
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-dim);
  font-weight: 600;
}

.leaderboard-table td {
  padding: 0.75rem 1rem;
  background: var(--surface);
  font-size: 0.85rem;
}

.leaderboard-table tr td:first-child { border-radius: 8px 0 0 8px; }
.leaderboard-table tr td:last-child { border-radius: 0 8px 8px 0; }

.rank-badge {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 0.75rem;
}

.rank-1 { background: linear-gradient(135deg, #ffd700, #f0c800); color: #000; }
.rank-2 { background: linear-gradient(135deg, #c0c0c0, #a8a8a8); color: #000; }
.rank-3 { background: linear-gradient(135deg, #cd7f32, #b8722a); color: #fff; }
.rank-other { background: var(--surface2); color: var(--text-dim); }

/* ─── Chapter Detail / Slide Browser ─── */
.chapter-detail-view { display: none; }

.slide-browser {
  display: grid;
  grid-template-columns: 250px 1fr;
  gap: 1.5rem;
}

.slide-list {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1rem;
  max-height: 80vh;
  overflow-y: auto;
}

.slide-list-item {
  padding: 0.6rem 0.8rem;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 0.8rem;
  transition: all 0.15s;
  margin-bottom: 2px;
}

.slide-list-item:hover { background: var(--surface2); }
.slide-list-item.active { background: var(--accent); color: #fff; }

.slide-list-item .slide-badge {
  background: var(--accent);
  color: #fff;
  font-size: 0.65rem;
  padding: 0.1rem 0.5rem;
  border-radius: 10px;
  font-weight: 700;
}

.slide-list-item.active .slide-badge {
  background: rgba(255,255,255,0.3);
}

/* ─── Filter bar ─── */
.filter-bar {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin-bottom: 1.5rem;
}

.filter-chip {
  padding: 0.35rem 0.8rem;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text-dim);
  transition: all 0.2s;
  font-family: inherit;
}

.filter-chip:hover { border-color: var(--accent); color: var(--text); }
.filter-chip.active { background: var(--accent); border-color: var(--accent); color: #fff; }

/* ─── Animations ─── */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.fade-in { animation: fadeIn 0.3s ease-out; }

@keyframes slideUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

.slide-up { animation: slideUp 0.4s ease-out; }

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

/* ─── Responsive ─── */
@media (max-width: 900px) {
  .dashboard-grid { grid-template-columns: 1fr; }
  .chapter-grid { grid-template-columns: repeat(2, 1fr); }
  .comparison-panels { grid-template-columns: 1fr; }
  .vs-divider { padding: 1rem 0; }
  .slide-browser { grid-template-columns: 1fr; }
  .study-options { grid-template-columns: 1fr; }
  .header-inner { flex-direction: column; align-items: flex-start; }
}

/* ─── Scrollbar ─── */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

/* ─── Toast ─── */
.toast {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  background: var(--accent);
  color: #fff;
  padding: 1rem 1.5rem;
  border-radius: 10px;
  font-size: 0.85rem;
  font-weight: 600;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.3s;
  z-index: 1000;
}

.toast.show { transform: translateY(0); opacity: 1; }

/* ─── Streak counter ─── */
.streak-display {
  position: fixed;
  top: 80px;
  right: 2rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 0.75rem 1rem;
  text-align: center;
  z-index: 50;
  display: none;
}

.streak-display .streak-num {
  font-size: 1.5rem;
  font-weight: 800;
  color: var(--orange);
}

.streak-display .streak-label {
  font-size: 0.65rem;
  color: var(--text-dim);
  text-transform: uppercase;
}

/* Supabase status indicator */
.db-status {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  font-size: 0.7rem;
  color: var(--text-dim);
}

.db-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--red);
}

.db-dot.connected { background: var(--green); }
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <div>
      <h1>Slide Improvement Showdown</h1>
      <div class="subtitle">BIOL 3000 Biochemistry - Can the students do better?</div>
    </div>
    <div class="nav-tabs">
      <button class="nav-tab active" data-view="dashboard">Dashboard</button>
      <button class="nav-tab" data-view="comparison">A/B Battle</button>
      <button class="nav-tab" data-view="study">Study Quiz</button>
      <button class="nav-tab" data-view="leaderboard">Leaderboard</button>
    </div>
    <div class="stats-bar">
      <div class="stat">
        <div class="stat-num" id="totalSubs">0</div>
        <div class="stat-label">Submissions</div>
      </div>
      <div class="stat">
        <div class="stat-num" id="totalVotes">0</div>
        <div class="stat-label">Votes Cast</div>
      </div>
      <div class="stat">
        <div class="db-status">
          <div class="db-dot" id="dbDot"></div>
          <span id="dbLabel">Connecting...</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ─── Dashboard ─── -->
<div class="main">
  <div id="dashboardView">
    <div class="dashboard-grid">
      <div class="card" style="grid-column: 1 / -1;">
        <div class="card-title">Chapters Overview</div>
        <div class="chapter-grid" id="chapterGrid"></div>
      </div>

      <div class="card" style="grid-column: 1 / -1;">
        <div class="card-title">Slide Heatmap - Which slides got the most improvements?</div>
        <div class="legend" id="heatLegend">
          <div class="legend-item"><div class="legend-dot" style="background: var(--surface2)"></div> 0</div>
          <div class="legend-item"><div class="legend-dot" style="background: #2d3a2d"></div> 1</div>
          <div class="legend-item"><div class="legend-dot" style="background: #3a5a2d"></div> 2-3</div>
          <div class="legend-item"><div class="legend-dot" style="background: #5a5a2d"></div> 4-5</div>
          <div class="legend-item"><div class="legend-dot" style="background: #7a2a2d"></div> 6+</div>
        </div>
        <div id="heatmapContainer"></div>
      </div>

      <div class="card">
        <div class="card-title">Submissions by Category</div>
        <canvas id="categoryChart" height="250"></canvas>
      </div>

      <div class="card">
        <div class="card-title">Submissions by Chapter</div>
        <canvas id="chapterChart" height="250"></canvas>
      </div>
    </div>
  </div>

  <!-- ─── A/B Comparison ─── -->
  <div id="comparisonView" class="comparison-view">
    <div class="filter-bar" id="compFilterBar"></div>
    <div class="comparison-header">
      <div class="comparison-nav">
        <button class="btn" id="prevSub" title="Previous">&larr; Prev</button>
        <span id="subCounter" style="font-size:0.85rem; color:var(--text-dim); min-width:80px; text-align:center;">1 / 505</span>
        <button class="btn" id="nextSub" title="Next">Next &rarr;</button>
        <button class="btn btn-accent" id="randomSub">Random</button>
      </div>
      <div id="compChapterSelect" style="display:flex; gap:0.5rem; flex-wrap:wrap;"></div>
    </div>
    <div class="comparison-panels">
      <div class="panel">
        <div class="panel-header original">
          <span>Original Slide</span>
          <span id="origSlideLabel" style="font-size:0.75rem; color:var(--text-dim);"></span>
        </div>
        <div class="panel-body">
          <div class="slide-preview" id="originalPreview">
            <span class="loading">Loading PDF slide...</span>
          </div>
        </div>
      </div>
      <div class="vs-divider">
        <div class="vs-badge">VS</div>
      </div>
      <div class="panel">
        <div class="panel-header improved">
          <span>Student Improvement</span>
          <span id="studentName" style="font-size:0.75rem; color:var(--text-dim);"></span>
        </div>
        <div class="panel-body">
          <div class="slide-preview" id="improvedPreview">
            <span class="loading">Loading submission...</span>
          </div>
          <div class="submission-info" id="submissionInfo"></div>
        </div>
      </div>
    </div>
    <div class="vote-section">
      <button class="vote-btn original-wins" id="voteOriginal">
        <span class="vote-icon">&#128077;</span>
        <span class="vote-label">Original is Better</span>
      </button>
      <div style="text-align:center;">
        <div class="vote-count" id="voteCountDisplay">No votes yet</div>
        <div class="vote-bar-container" style="width:200px; margin-top:0.5rem;">
          <span style="font-size:0.65rem; color:var(--red);">Orig</span>
          <div class="vote-bar">
            <div class="vote-bar-original" id="voteBarOrig" style="width:50%"></div>
            <div class="vote-bar-improved" id="voteBarImp" style="width:50%"></div>
          </div>
          <span style="font-size:0.65rem; color:var(--green);">New</span>
        </div>
      </div>
      <button class="vote-btn improved-wins" id="voteImproved">
        <span class="vote-icon">&#11088;</span>
        <span class="vote-label">Improvement Wins!</span>
      </button>
    </div>
  </div>

  <!-- ─── Study Quiz ─── -->
  <div id="studyView" class="study-view">
    <div class="study-card">
      <div class="study-progress">
        <div class="progress-bar"><div class="progress-fill" id="studyProgress" style="width:0%"></div></div>
        <div class="progress-text" id="studyProgressText">0 / 10</div>
      </div>
      <div class="study-body" id="studyBody">
        <div style="text-align:center;">
          <h2 style="margin-bottom:1rem;">Study Quiz Mode</h2>
          <p style="color:var(--text-dim); margin-bottom:1.5rem; max-width:500px; margin-left:auto; margin-right:auto; line-height:1.6;">
            See an original slide and guess what category of improvement a student found. Then review their fix to learn the material!
          </p>
          <div style="display:flex; gap:0.75rem; justify-content:center; flex-wrap:wrap; margin-bottom:1.5rem;">
            <button class="btn" id="quiz10">10 Questions</button>
            <button class="btn btn-accent" id="quiz20">20 Questions</button>
            <button class="btn" id="quizAll">All Slides</button>
          </div>
          <div style="margin-bottom:1rem;">
            <label style="font-size:0.8rem; color:var(--text-dim);">Filter by chapter:</label>
            <select id="quizChapterFilter" style="background:var(--surface2); color:var(--text); border:1px solid var(--border); border-radius:6px; padding:0.4rem 0.8rem; margin-left:0.5rem; font-family:inherit;">
              <option value="all">All Chapters</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    <div class="streak-display" id="streakDisplay">
      <div class="streak-num" id="streakNum">0</div>
      <div class="streak-label">Streak</div>
    </div>
  </div>

  <!-- ─── Leaderboard ─── -->
  <div id="leaderboardView" class="leaderboard-view">
    <div class="card">
      <div class="card-title">Top Rated Improvements</div>
      <p style="color:var(--text-dim); font-size:0.8rem; margin-bottom:1rem;">Ranked by community votes. Cast your votes in A/B Battle mode!</p>
      <div class="filter-bar" id="lbFilterBar"></div>
      <table class="leaderboard-table" id="leaderboardTable">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Student</th>
            <th>Chapter</th>
            <th>Slide</th>
            <th>Category</th>
            <th>Votes For</th>
            <th>Win Rate</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ─── Configuration ───
const SUPABASE_URL = 'YOUR_SUPABASE_URL';
const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';
const PDF_BASE_PATH = 'slide pdfs without presenter notes/';

// ─── State ───
let appData = null;
let currentSubIndex = 0;
let filteredSubs = [];
let activeCategory = null;
let activeChapter = null;
let votes = {}; // submissionId -> { original: n, improved: n }
let myVotes = {}; // submissionId -> 'original' | 'improved'
let pdfCache = {}; // chapterPdf -> PDFDocumentProxy
let studyState = null;
let supabase = null;
let dbConnected = false;

// ─── PDF.js Setup ───
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// ─── Initialize ───
async function init() {
  const resp = await fetch('app_data.json');
  appData = await resp.json();

  document.getElementById('totalSubs').textContent = appData.totalSubmissions;
  filteredSubs = [...appData.submissions];

  initSupabase();
  renderDashboard();
  setupNavigation();
  setupComparison();
  setupStudyMode();
  setupLeaderboard();
}

// ─── Supabase ───
async function initSupabase() {
  const dot = document.getElementById('dbDot');
  const label = document.getElementById('dbLabel');

  if (SUPABASE_URL === 'YOUR_SUPABASE_URL') {
    // Fallback to localStorage
    dot.classList.remove('connected');
    label.textContent = 'Local mode';
    loadLocalVotes();
    return;
  }

  try {
    // Dynamic import of Supabase
    const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
    supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
    dbConnected = true;
    dot.classList.add('connected');
    label.textContent = 'Live voting';
    await loadVotesFromDB();
  } catch (e) {
    console.error('Supabase init failed:', e);
    label.textContent = 'Local mode';
    loadLocalVotes();
  }
}

function loadLocalVotes() {
  try {
    votes = JSON.parse(localStorage.getItem('slideVotes') || '{}');
    myVotes = JSON.parse(localStorage.getItem('myVotes') || '{}');
    updateTotalVoteCount();
  } catch(e) { votes = {}; myVotes = {}; }
}

function saveLocalVotes() {
  localStorage.setItem('slideVotes', JSON.stringify(votes));
  localStorage.setItem('myVotes', JSON.stringify(myVotes));
}

async function loadVotesFromDB() {
  if (!supabase) return loadLocalVotes();
  try {
    const { data, error } = await supabase.from('votes').select('*');
    if (error) throw error;
    votes = {};
    (data || []).forEach(row => {
      if (!votes[row.submission_id]) votes[row.submission_id] = { original: 0, improved: 0 };
      votes[row.submission_id][row.vote_type] = (votes[row.submission_id][row.vote_type] || 0) + 1;
    });
    // Load user's own votes from localStorage for "already voted" state
    myVotes = JSON.parse(localStorage.getItem('myVotes') || '{}');
    updateTotalVoteCount();
  } catch(e) {
    console.error('Failed to load votes:', e);
    loadLocalVotes();
  }
}

async function castVote(submissionId, voteType) {
  if (!votes[submissionId]) votes[submissionId] = { original: 0, improved: 0 };
  votes[submissionId][voteType]++;
  myVotes[submissionId] = voteType;
  localStorage.setItem('myVotes', JSON.stringify(myVotes));
  updateTotalVoteCount();

  if (supabase && dbConnected) {
    try {
      const sessionId = getSessionId();
      await supabase.from('votes').insert({
        submission_id: submissionId,
        vote_type: voteType,
        session_id: sessionId
      });
    } catch(e) {
      console.error('Vote save failed:', e);
    }
  }

  saveLocalVotes();
}

function getSessionId() {
  let sid = localStorage.getItem('sessionId');
  if (!sid) {
    sid = 'sess_' + Math.random().toString(36).substr(2,12);
    localStorage.setItem('sessionId', sid);
  }
  return sid;
}

function updateTotalVoteCount() {
  let total = 0;
  Object.values(votes).forEach(v => { total += (v.original || 0) + (v.improved || 0); });
  document.getElementById('totalVotes').textContent = total;
}

// ─── Navigation ───
function setupNavigation() {
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      const view = tab.dataset.view;
      document.getElementById('dashboardView').style.display = view === 'dashboard' ? '' : 'none';
      document.getElementById('comparisonView').style.display = view === 'comparison' ? '' : 'none';
      document.getElementById('studyView').style.display = view === 'study' ? '' : 'none';
      document.getElementById('leaderboardView').style.display = view === 'leaderboard' ? '' : 'none';

      if (view === 'comparison') showComparison(currentSubIndex);
      if (view === 'leaderboard') renderLeaderboard();
    });
  });
}

// ─── Dashboard ───
function renderDashboard() {
  // Chapter cards
  const grid = document.getElementById('chapterGrid');
  const chNums = Object.keys(appData.chapters).sort((a,b) => a - b);

  const chapterNames = {
    1: 'Unity of Life',
    2: 'Water & pH',
    3: 'Amino Acids',
    4: 'Protein Folding',
    5: 'Hemoglobin',
    6: 'Techniques',
    7: 'Enzymes',
    8: 'Enzyme Kinetics'
  };

  grid.innerHTML = chNums.map(n => {
    const ch = appData.chapters[n];
    return `
      <div class="chapter-card" onclick="jumpToChapter(${n})">
        <div class="ch-num">${n}</div>
        <div class="ch-name">${chapterNames[n] || ch.name}</div>
        <div class="ch-stats">${ch.totalSubmissions} submissions</div>
        <div style="font-size:0.65rem; color:var(--text-dim); margin-top:0.2rem;">${ch.totalPages} slides</div>
      </div>
    `;
  }).join('');

  // Heatmap
  renderHeatmap();

  // Charts
  renderCategoryChart();
  renderChapterChart();
}

function renderHeatmap() {
  const container = document.getElementById('heatmapContainer');
  const chNums = Object.keys(appData.chapters).sort((a,b) => a - b);

  const chapterNames = {
    1: 'Ch 1: Unity of Life',
    2: 'Ch 2: Water & pH',
    3: 'Ch 3: Amino Acids',
    4: 'Ch 4: Protein Folding',
    5: 'Ch 5: Hemoglobin',
    6: 'Ch 6: Techniques',
    7: 'Ch 7: Enzymes',
    8: 'Ch 8: Enzyme Kinetics'
  };

  container.innerHTML = chNums.map(n => {
    const ch = appData.chapters[n];
    const cells = [];
    for (let s = 1; s <= ch.totalPages; s++) {
      const count = ch.slideCounts[s] || 0;
      let heat = 'heat-0';
      if (count >= 6) heat = 'heat-6';
      else if (count >= 4) heat = 'heat-5';
      else if (count >= 3) heat = 'heat-4';
      else if (count >= 2) heat = 'heat-3';
      else if (count >= 1) heat = 'heat-1';
      cells.push(`<div class="heatmap-cell ${heat}" title="Ch ${n}, Slide ${s}: ${count} submission${count!==1?'s':''}" onclick="jumpToSlide(${n},${s})">${s}</div>`);
    }
    return `
      <div class="heatmap-chapter-title">${chapterNames[n]} (${ch.totalSubmissions} submissions)</div>
      <div class="heatmap-row">${cells.join('')}</div>
    `;
  }).join('');
}

function renderCategoryChart() {
  const ctx = document.getElementById('categoryChart').getContext('2d');
  const cats = {};
  appData.submissions.forEach(s => {
    s.categories.forEach(c => { cats[c] = (cats[c] || 0) + 1; });
  });

  const labels = Object.keys(cats).sort((a,b) => cats[b] - cats[a]);
  const colors = {
    'Factual Fix': '#e17055',
    'Visual Overhaul': '#6c5ce7',
    'Clinical Hook': '#00cec9',
    'Aha! Analogy': '#fdcb6e',
    'Publisher Comparison': '#fd79a8',
    'Other': '#74b9ff'
  };

  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: labels.map(l => cats[l]),
        backgroundColor: labels.map(l => colors[l] || '#74b9ff'),
        borderWidth: 0,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#8b8fa3', font: { size: 11 }, padding: 12 }
        }
      }
    }
  });
}

function renderChapterChart() {
  const ctx = document.getElementById('chapterChart').getContext('2d');
  const chNums = Object.keys(appData.chapters).sort((a,b) => a - b);
  const shortNames = ['Unity','Water','AAs','Protein','Hb','Tech','Enzymes','Kinetics'];

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: chNums.map((n,i) => `Ch ${n}: ${shortNames[i]}`),
      datasets: [{
        label: 'Submissions',
        data: chNums.map(n => appData.chapters[n].totalSubmissions),
        backgroundColor: [
          '#e17055','#6c5ce7','#00cec9','#fdcb6e','#fd79a8','#74b9ff','#00b894','#a29bfe'
        ],
        borderRadius: 6,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          ticks: { color: '#8b8fa3' },
          grid: { color: '#2e3347' }
        },
        x: {
          ticks: { color: '#8b8fa3', font: { size: 10 } },
          grid: { display: false }
        }
      }
    }
  });
}

// ─── Jump helpers ───
function jumpToChapter(chNum) {
  activeChapter = chNum;
  filterSubmissions();
  document.querySelector('[data-view="comparison"]').click();
}

function jumpToSlide(chNum, slideNum) {
  activeChapter = chNum;
  filterSubmissions();
  // Find first submission matching this slide
  const idx = filteredSubs.findIndex(s => s.chapterNum === chNum && s.slideNum === slideNum);
  if (idx >= 0) currentSubIndex = idx;
  document.querySelector('[data-view="comparison"]').click();
}

// ─── A/B Comparison ───
function setupComparison() {
  // Chapter filter chips
  const bar = document.getElementById('compChapterSelect');
  const shortNames = {1:'Ch1',2:'Ch2',3:'Ch3',4:'Ch4',5:'Ch5',6:'Ch6',7:'Ch7',8:'Ch8'};

  bar.innerHTML = `<button class="filter-chip active" data-ch="all">All</button>` +
    Object.keys(appData.chapters).sort((a,b)=>a-b).map(n =>
      `<button class="filter-chip" data-ch="${n}">${shortNames[n]}</button>`
    ).join('');

  bar.querySelectorAll('.filter-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      bar.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      activeChapter = chip.dataset.ch === 'all' ? null : parseInt(chip.dataset.ch);
      filterSubmissions();
      currentSubIndex = 0;
      showComparison(0);
    });
  });

  // Category filter
  const catBar = document.getElementById('compFilterBar');
  const cats = ['All', 'Factual Fix', 'Visual Overhaul', 'Clinical Hook', 'Aha! Analogy', 'Publisher Comparison'];
  catBar.innerHTML = cats.map(c =>
    `<button class="filter-chip ${c==='All'?'active':''}" data-cat="${c}">${c}</button>`
  ).join('');

  catBar.querySelectorAll('.filter-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      catBar.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      activeCategory = chip.dataset.cat === 'All' ? null : chip.dataset.cat;
      filterSubmissions();
      currentSubIndex = 0;
      showComparison(0);
    });
  });

  document.getElementById('prevSub').addEventListener('click', () => {
    if (currentSubIndex > 0) showComparison(--currentSubIndex);
  });
  document.getElementById('nextSub').addEventListener('click', () => {
    if (currentSubIndex < filteredSubs.length - 1) showComparison(++currentSubIndex);
  });
  document.getElementById('randomSub').addEventListener('click', () => {
    currentSubIndex = Math.floor(Math.random() * filteredSubs.length);
    showComparison(currentSubIndex);
  });

  document.getElementById('voteOriginal').addEventListener('click', () => handleVote('original'));
  document.getElementById('voteImproved').addEventListener('click', () => handleVote('improved'));

  // Keyboard navigation
  document.addEventListener('keydown', e => {
    if (document.getElementById('comparisonView').style.display === 'none') return;
    if (e.key === 'ArrowLeft') document.getElementById('prevSub').click();
    if (e.key === 'ArrowRight') document.getElementById('nextSub').click();
    if (e.key === '1') document.getElementById('voteOriginal').click();
    if (e.key === '2') document.getElementById('voteImproved').click();
    if (e.key === 'r') document.getElementById('randomSub').click();
  });
}

function filterSubmissions() {
  filteredSubs = appData.submissions.filter(s => {
    if (activeChapter && s.chapterNum !== activeChapter) return false;
    if (activeCategory && !s.categories.includes(activeCategory)) return false;
    return true;
  });
}

async function showComparison(idx) {
  if (filteredSubs.length === 0) {
    document.getElementById('subCounter').textContent = 'No submissions match filter';
    return;
  }

  idx = Math.max(0, Math.min(idx, filteredSubs.length - 1));
  currentSubIndex = idx;
  const sub = filteredSubs[idx];

  document.getElementById('subCounter').textContent = `${idx + 1} / ${filteredSubs.length}`;
  document.getElementById('origSlideLabel').textContent = `${sub.chapter} - Slide ${sub.slideRaw}`;
  document.getElementById('studentName').textContent = `${sub.name} (Pod ${sub.pod})`;

  // Render original PDF slide
  await renderPdfSlide(sub);

  // Render student submission
  renderStudentSubmission(sub);

  // Show submission info
  const catTags = sub.categories.map(c => {
    const cls = c.toLowerCase().replace(/[^a-z]/g, '-').replace(/--+/g, '-');
    return `<span class="cat-tag ${cls}">${c}</span>`;
  }).join('');

  document.getElementById('submissionInfo').innerHTML = `
    <div class="label">Category</div>
    <div class="category-tags">${catTags}</div>
    <div class="label" style="margin-top:0.75rem;">Why is this better?</div>
    <p>${escapeHtml(sub.explanation)}</p>
    ${sub.notes ? `<div class="label">Presenter Notes</div><p style="max-height:150px; overflow-y:auto;">${escapeHtml(sub.notes).substring(0, 500)}${sub.notes.length > 500 ? '...' : ''}</p>` : ''}
  `;

  // Update vote display
  updateVoteDisplay(sub.id);
}

async function renderPdfSlide(sub) {
  const container = document.getElementById('originalPreview');
  container.innerHTML = '<span class="loading">Loading original slide...</span>';

  if (!sub.chapterPdf || !sub.slideNum) {
    container.innerHTML = '<span class="loading">Slide reference not available</span>';
    return;
  }

  try {
    if (!pdfCache[sub.chapterPdf]) {
      const loadingTask = pdfjsLib.getDocument(PDF_BASE_PATH + sub.chapterPdf);
      pdfCache[sub.chapterPdf] = await loadingTask.promise;
    }

    const pdf = pdfCache[sub.chapterPdf];
    const pageNum = Math.min(sub.slideNum, pdf.numPages);
    const page = await pdf.getPage(pageNum);

    const viewport = page.getViewport({ scale: 1 });
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    // Scale to fit container
    const containerWidth = container.clientWidth || 600;
    const scale = containerWidth / viewport.width;
    const scaledViewport = page.getViewport({ scale: scale });

    canvas.width = scaledViewport.width;
    canvas.height = scaledViewport.height;

    await page.render({ canvasContext: ctx, viewport: scaledViewport }).promise;

    container.innerHTML = '';
    container.appendChild(canvas);
  } catch (e) {
    console.error('PDF render error:', e);
    container.innerHTML = '<span class="loading">Could not load slide</span>';
  }
}

function renderStudentSubmission(sub) {
  const container = document.getElementById('improvedPreview');

  if (!sub.driveId) {
    container.innerHTML = '<span class="loading">No file uploaded</span>';
    return;
  }

  // Use Google Drive preview - works for images, PDFs, and PPTX
  // Try thumbnail first (faster), fall back to preview iframe
  const thumbnailUrl = `https://drive.google.com/thumbnail?id=${sub.driveId}&sz=w800`;
  const previewUrl = `https://drive.google.com/file/d/${sub.driveId}/preview`;

  const img = document.createElement('img');
  img.src = thumbnailUrl;
  img.alt = 'Student submission';
  img.style.maxWidth = '100%';
  img.style.maxHeight = '100%';
  img.style.objectFit = 'contain';

  img.onerror = () => {
    // Fall back to iframe preview
    container.innerHTML = `<iframe src="${previewUrl}" style="width:100%;height:100%;border:none;" allow="autoplay"></iframe>`;
  };

  container.innerHTML = '';
  container.appendChild(img);
}

function handleVote(voteType) {
  const sub = filteredSubs[currentSubIndex];
  if (!sub || myVotes[sub.id]) return; // Already voted

  castVote(sub.id, voteType);
  updateVoteDisplay(sub.id);

  // Visual feedback
  showToast(voteType === 'improved' ? 'Voted: Student wins!' : 'Voted: Original wins!');

  // Auto-advance after a short delay
  setTimeout(() => {
    if (currentSubIndex < filteredSubs.length - 1) {
      showComparison(++currentSubIndex);
    }
  }, 1200);
}

function updateVoteDisplay(subId) {
  const v = votes[subId] || { original: 0, improved: 0 };
  const total = v.original + v.improved;

  const countEl = document.getElementById('voteCountDisplay');
  const barOrig = document.getElementById('voteBarOrig');
  const barImp = document.getElementById('voteBarImp');
  const btnOrig = document.getElementById('voteOriginal');
  const btnImp = document.getElementById('voteImproved');

  if (total === 0) {
    countEl.textContent = 'No votes yet - be the first!';
    barOrig.style.width = '50%';
    barImp.style.width = '50%';
  } else {
    const origPct = Math.round((v.original / total) * 100);
    const impPct = 100 - origPct;
    countEl.textContent = `${total} vote${total!==1?'s':''}: Original ${origPct}% vs Improved ${impPct}%`;
    barOrig.style.width = origPct + '%';
    barImp.style.width = impPct + '%';
  }

  // Show if already voted
  const alreadyVoted = myVotes[subId];
  btnOrig.classList.toggle('voted', !!alreadyVoted);
  btnImp.classList.toggle('voted', !!alreadyVoted);

  if (alreadyVoted === 'original') {
    btnOrig.style.borderColor = 'var(--red)';
    btnOrig.style.opacity = '1';
  } else if (alreadyVoted === 'improved') {
    btnImp.style.borderColor = 'var(--green)';
    btnImp.style.opacity = '1';
  } else {
    btnOrig.style.borderColor = '';
    btnOrig.style.opacity = '';
    btnImp.style.borderColor = '';
    btnImp.style.opacity = '';
  }
}

// ─── Study Quiz Mode ───
function setupStudyMode() {
  const sel = document.getElementById('quizChapterFilter');
  Object.keys(appData.chapters).sort((a,b)=>a-b).forEach(n => {
    const opt = document.createElement('option');
    opt.value = n;
    opt.textContent = appData.chapters[n].name;
    sel.appendChild(opt);
  });

  document.getElementById('quiz10').addEventListener('click', () => startQuiz(10));
  document.getElementById('quiz20').addEventListener('click', () => startQuiz(20));
  document.getElementById('quizAll').addEventListener('click', () => startQuiz(0));
}

function startQuiz(numQuestions) {
  const chFilter = document.getElementById('quizChapterFilter').value;
  let pool = appData.submissions.filter(s => s.slideNum && s.chapterPdf);
  if (chFilter !== 'all') {
    pool = pool.filter(s => s.chapterNum === parseInt(chFilter));
  }

  // Shuffle
  pool = pool.sort(() => Math.random() - 0.5);
  if (numQuestions > 0) pool = pool.slice(0, numQuestions);

  studyState = {
    questions: pool,
    current: 0,
    score: 0,
    streak: 0,
    maxStreak: 0
  };

  document.getElementById('streakDisplay').style.display = 'block';
  showStudyQuestion();
}

async function showStudyQuestion() {
  if (!studyState || studyState.current >= studyState.questions.length) {
    showStudyResults();
    return;
  }

  const q = studyState.questions[studyState.current];
  const total = studyState.questions.length;
  const pct = Math.round((studyState.current / total) * 100);

  document.getElementById('studyProgress').style.width = pct + '%';
  document.getElementById('studyProgressText').textContent = `${studyState.current + 1} / ${total}`;
  document.getElementById('streakNum').textContent = studyState.streak;

  const body = document.getElementById('studyBody');
  body.innerHTML = `
    <div class="study-prompt">Look at this slide from ${q.chapter}. What did a student improve?</div>
    <div class="study-slide-container">
      <div class="study-slide-preview" id="studySlidePreview">
        <span class="loading">Loading slide...</span>
      </div>
    </div>
    <div class="study-options" id="studyOptions">
      <button class="study-option" data-answer="Factual Fix">Found a Factual Error</button>
      <button class="study-option" data-answer="Visual Overhaul">Better Visual/Diagram</button>
      <button class="study-option" data-answer="Aha! Analogy">Better Explanation/Analogy</button>
      <button class="study-option" data-answer="Clinical Hook">Clinical/Historical Connection</button>
    </div>
    <div class="reveal-section" id="revealSection">
      <h3>The student's improvement:</h3>
      <p id="revealText"></p>
      <div style="margin-top:1rem;">
        <button class="btn btn-accent" id="nextQuestion">Next Question &rarr;</button>
      </div>
    </div>
  `;

  // Render the PDF slide
  const container = document.getElementById('studySlidePreview');
  try {
    if (!pdfCache[q.chapterPdf]) {
      pdfCache[q.chapterPdf] = await pdfjsLib.getDocument(PDF_BASE_PATH + q.chapterPdf).promise;
    }
    const pdf = pdfCache[q.chapterPdf];
    const pageNum = Math.min(q.slideNum, pdf.numPages);
    const page = await pdf.getPage(pageNum);
    const viewport = page.getViewport({ scale: 1 });
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const containerWidth = container.clientWidth || 700;
    const scale = containerWidth / viewport.width;
    const sv = page.getViewport({ scale });
    canvas.width = sv.width;
    canvas.height = sv.height;
    await page.render({ canvasContext: ctx, viewport: sv }).promise;
    container.innerHTML = '';
    container.appendChild(canvas);
  } catch(e) {
    container.innerHTML = '<span class="loading">Could not load slide</span>';
  }

  // Set up answer clicks
  document.querySelectorAll('.study-option').forEach(opt => {
    opt.addEventListener('click', () => handleStudyAnswer(opt, q));
  });
}

function handleStudyAnswer(optEl, question) {
  // Disable all options
  document.querySelectorAll('.study-option').forEach(o => {
    o.style.pointerEvents = 'none';
  });

  const answer = optEl.dataset.answer;
  const correct = question.categories.includes(answer);

  if (correct) {
    optEl.classList.add('correct');
    studyState.score++;
    studyState.streak++;
    studyState.maxStreak = Math.max(studyState.maxStreak, studyState.streak);
    document.getElementById('streakNum').textContent = studyState.streak;
  } else {
    optEl.classList.add('wrong');
    studyState.streak = 0;
    document.getElementById('streakNum').textContent = 0;
    // Highlight correct answer(s)
    document.querySelectorAll('.study-option').forEach(o => {
      if (question.categories.includes(o.dataset.answer)) o.classList.add('correct');
    });
  }

  // Show reveal
  const reveal = document.getElementById('revealSection');
  reveal.style.display = 'block';
  document.getElementById('revealText').textContent = question.explanation || 'No explanation provided.';

  document.getElementById('nextQuestion').addEventListener('click', () => {
    studyState.current++;
    showStudyQuestion();
  });
}

function showStudyResults() {
  const total = studyState.questions.length;
  const pct = Math.round((studyState.score / total) * 100);

  document.getElementById('studyProgress').style.width = '100%';
  document.getElementById('studyProgressText').textContent = 'Complete!';
  document.getElementById('streakDisplay').style.display = 'none';

  document.getElementById('studyBody').innerHTML = `
    <div class="study-score slide-up">
      <div class="score-num">${pct}%</div>
      <p style="font-size:1.2rem; margin:0.5rem 0;">${studyState.score} / ${total} correct</p>
      <p style="color:var(--text-dim);">Best streak: ${studyState.maxStreak}</p>
      <p style="color:var(--text-dim); margin-top:0.5rem;">
        ${pct >= 80 ? 'Excellent! You really know your biochemistry!' :
          pct >= 60 ? 'Good job! Keep reviewing those slides.' :
          pct >= 40 ? 'Not bad - the slides have some tricky issues!' :
          'Time to review! Try the A/B comparison to learn more.'}
      </p>
      <div style="margin-top:1.5rem; display:flex; gap:0.75rem; justify-content:center;">
        <button class="btn btn-accent" onclick="startQuiz(${total})">Try Again</button>
        <button class="btn" onclick="document.querySelector('[data-view=comparison]').click()">Go to A/B Battle</button>
      </div>
    </div>
  `;
}

// ─── Leaderboard ───
function setupLeaderboard() {
  const bar = document.getElementById('lbFilterBar');
  const cats = ['All', 'Factual Fix', 'Visual Overhaul', 'Clinical Hook', 'Aha! Analogy'];
  bar.innerHTML = cats.map(c =>
    `<button class="filter-chip ${c==='All'?'active':''}" data-cat="${c}">${c}</button>`
  ).join('');

  bar.querySelectorAll('.filter-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      bar.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      renderLeaderboard(chip.dataset.cat === 'All' ? null : chip.dataset.cat);
    });
  });
}

function renderLeaderboard(catFilter) {
  const tbody = document.getElementById('leaderboardBody');

  // Score each submission
  let scored = appData.submissions.map(s => {
    const v = votes[s.id] || { original: 0, improved: 0 };
    const total = v.original + v.improved;
    const winRate = total > 0 ? v.improved / total : 0;
    return { ...s, votesFor: v.improved, votesAgainst: v.original, totalVotes: total, winRate };
  });

  if (catFilter) {
    scored = scored.filter(s => s.categories.includes(catFilter));
  }

  // Sort by votes for, then win rate
  scored.sort((a,b) => b.votesFor - a.votesFor || b.winRate - a.winRate);
  scored = scored.slice(0, 50); // Top 50

  tbody.innerHTML = scored.map((s, i) => {
    const rank = i + 1;
    const rankClass = rank <= 3 ? `rank-${rank}` : 'rank-other';
    const catTags = s.categories.map(c => {
      const cls = c.toLowerCase().replace(/[^a-z]/g, '-').replace(/--+/g, '-');
      return `<span class="cat-tag ${cls}">${c}</span>`;
    }).join(' ');

    return `
      <tr style="cursor:pointer;" onclick="jumpToSubmission(${s.id})">
        <td><div class="rank-badge ${rankClass}">${rank}</div></td>
        <td><strong>${escapeHtml(s.name)}</strong></td>
        <td style="font-size:0.8rem; color:var(--text-dim);">${s.chapter}</td>
        <td>Slide ${s.slideRaw}</td>
        <td>${catTags}</td>
        <td style="font-weight:700; color:var(--green);">${s.votesFor}</td>
        <td>
          <div style="display:flex; align-items:center; gap:0.5rem;">
            <div style="width:60px; height:6px; background:var(--surface2); border-radius:3px; overflow:hidden;">
              <div style="width:${Math.round(s.winRate*100)}%; height:100%; background:var(--green); border-radius:3px;"></div>
            </div>
            <span style="font-size:0.8rem;">${s.totalVotes > 0 ? Math.round(s.winRate*100)+'%' : '-'}</span>
          </div>
        </td>
      </tr>
    `;
  }).join('');

  if (scored.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:var(--text-dim); padding:2rem;">No votes yet! Go to A/B Battle to start voting.</td></tr>';
  }
}

function jumpToSubmission(subId) {
  const idx = filteredSubs.findIndex(s => s.id === subId);
  if (idx >= 0) {
    currentSubIndex = idx;
  } else {
    // Reset filters
    activeCategory = null;
    activeChapter = null;
    filterSubmissions();
    currentSubIndex = filteredSubs.findIndex(s => s.id === subId);
    if (currentSubIndex < 0) currentSubIndex = 0;
  }
  document.querySelector('[data-view="comparison"]').click();
}

// ─── Utilities ───
function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

// ─── Start ───
init();
</script>
</body>
</html>
